<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>動態轉盤</title>
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/2.0.0/uicons-regular-rounded/css/uicons-regular-rounded.css'>
<style type="text/css">
    body{
        overflow-x: hidden;
    }
    .container{
        width:600px; 
        position: relative; 
        margin: auto;
        margin-top: 5%; 
        text-align: center;
        height:530px;
    }
    

    #i-left{
        display: flex;
        font-size: 72px;
        position: absolute;
        left: 914px; /* 设置固定的水平位置 */
        top: 285px; /* 设置固定的垂直位置 */
    }
</style>
</head>
<body>
    <div class="container">
        <canvas id="canvas" width="550" height="500"></canvas>
    </div>
    
    <i class="fi fi-rr-caret-left" id="i-left"></i>
    <div class="button">
        <button onclick="spinWheel()">轉動轉盤</button>
        <div id="result"></div>   
        <div id="error"></div>
        <form id="optionForm">
          <input type="text" id="optionInput" placeholder="輸入選項" required />
          <input type="color" id="colorInput" required />
        <input type="number" id="percentageInput" placeholder="輸入%" min="0" max="100"/>
          <input type="submit" value="添加選項" />
        </form>
        <div id="allOptions"></div>
        <form id="deleteForm">
          <input type="text" id="deleteInput" placeholder="輸入要刪除的選項名稱" required />
          <input type="submit" id="delete" value="刪除選項" />
        </form>

    </div>
</body>
</html>

<script>
    var options = []; // 一開始陣列是空的
    var canvas = document.getElementById('canvas'); //畫布
    var ctx = canvas.getContext('2d');
    var result = document.getElementById('result'); //顯示結果
    var error = document.getElementById('error'); //錯誤訊息
    var optionForm = document.getElementById('optionForm'); //新增表單
    var optionInput = document.getElementById('optionInput');//新增輸入框
    var colorInput = document.getElementById('colorInput');//顏色選擇
    var check=false;                                       //是否再旋轉
    var deleteForm = document.getElementById('deleteForm');//刪除表單
    var deleteInput = document.getElementById('deleteInput');//刪除輸入框
    
    colorInput.addEventListener('input', function() {
        if (colorInput.value.toUpperCase() === '#FFFFFF') {
            alert('不可以選白色喔');
            colorInput.value = '#000000'; // 將顏色更改為黑色
        }
    });
    
    //--------------------新增選項-----------------//
    optionForm.onsubmit = function(event) {
        var percentageInput = document.getElementById('percentageInput');//抓輸入%
        var newPercentage = parseFloat(percentageInput.value);//輸入%
        var currentTotalPercentage = options.reduce((total, opt) => total + opt.percentage, 0);//加總
        event.preventDefault(); // 防止表單提交
        
            // 檢查輸入
        if (isNaN(newPercentage) || newPercentage < 0 || newPercentage > 100) { //>100<0錯誤
            error.textContent = '輸入有效的百分比（0-100）';
            return;
        }
    
        //檢查超過100%
        if (currentTotalPercentage + newPercentage > 100) {
            error.textContent = '所有百分比加起來不能超過100％';
            return;
        }
        
        if(check){
            error.textContent="轉盤正在轉動中，請等待結果...";
            return;
        }
        
        // 添加新的選項到陣列    
            options.push({
                option: optionInput.value,   //加入輸入框內容
                color: colorInput.value,      //加入顏色
                percentage: newPercentage
            });
        
            // 清空輸入
            optionInput.value = '';
            colorInput.value = '#000000';
            percentageInput.value = '';
            error.textContent = '';
            
            // 重繪轉盤
            drawWheel();
            updateDisplay();
    }

        
    //-----------------繪製圓餅圖-----------------//
    function drawWheel() {
        var currentAngle = 0; // 初始角度
        var arcSize=0;
        var angleMidpoint = 0;
        
        ctx.clearRect(0, 0, canvas.width, canvas.height); // 清除之前
        options.forEach((opt) => {
            arcSize = (2 * Math.PI) * (opt.percentage / 100); // 根据百分比計算扇形角度
            angleMidpoint=currentAngle + arcSize / 2;
            
            // 繪制扇區
            ctx.beginPath();
            ctx.arc(250, 250, 250, currentAngle, currentAngle + arcSize, false);
            ctx.lineTo(250, 250);
            ctx.fillStyle = opt.color;
            ctx.fill();
            
            ctx.save();
            ctx.translate(250, 250);
            ctx.rotate(angleMidpoint);
            ctx.textAlign = 'left';
            ctx.fillStyle = 'white'; // 文本顏色
            ctx.font = 'bold 28px sans-serif'; // 文本樣式
            ctx.fillText(opt.option, 180, 10);
            ctx.restore();
            
            currentAngle += arcSize; // 更新當前角度
        });
    }
          
    //----------------------刪除選項---------------------//
    deleteForm.onsubmit = function(event) { 
        var deleteOption = deleteInput.value;
        var found = false;
        
        event.preventDefault(); // 防止表單提交
        if(check){ //轉動期間不能再轉
            error.textContent="轉盤正在轉動中，不能刪除";
            return;
        }
        else{
            for (var i = 0; i < options.length; i++) {
                if (options[i].option === deleteOption) {
                    options.splice(i, 1); // 從陣列中刪除
                    found = true;
                    break;
                }
            }
            
            if (!found) {
                error.textContent = '未找到指定的選項';
            } else {
                error.textContent = '';
                updateDisplay(); // 更新顯示
                drawWheel(); // 重繪轉盤
            }
            deleteInput.value = ''; // 清空輸入
        }
    };
    
    //------------------------顯示內容--------------------//
    function updateDisplay() {
        var allOptions = document.getElementById('allOptions');
        
        allOptions.innerHTML = ''; // 清空當前內容
        options.forEach((opt, index) => {
            allOptions.innerHTML += `選項${index + 1}: ${opt.option},${opt.percentage}% `; // 添加每個選項
        });
    }
    
    //------------------------轉動------------------------//
    function spinWheel() {
        var totalOptions = options.length;                 //選項的總數
        var spinTo = Math.random() * (8000 - 5000) + 5000; //旋轉的時間
        var duration = 6000;                               //轉的持續時間
        var startTimestamp;                                //旋轉開始的時間軸
        var progress;                                      //當前旋轉進度
        var angle;                                         //當前旋轉角度
        var selectedOptionIndex;                           //被選中的選項
        var step;
        var totalPercentage = options.reduce((total, opt) => total + opt.percentage, 0); //計算選項%總和

        if(totalPercentage!=100){//沒有100%不能轉動
            error.textContent="轉盤%不足100%，請添加選項";
            return;
        }
        else{
            if(check){ //轉動期間不能再轉
                error.textContent="轉盤正在轉動中，請等待結果...";
                return;
            }
            else{ //沒有選項跟只有一個不能
                if(options.length === 0 || options.length === 1){
                    result.textContent = "轉盤選項不夠喔";
                }
                else{
                    check = true; // 設置轉盤正在轉動的標誌
                    error.textContent = ''; // 清除錯誤消息
                    deleteInput.value = '';
                    
                    step = (timestamp) => {
                        if (!startTimestamp)
                            startTimestamp = timestamp; //如果是動畫的第一步,紀錄時間
                        progress = timestamp - startTimestamp;//計算進度
                        angle = easeOutCubic(progress, 0, spinTo, duration); //計算當前角度
                        ctx.clearRect(0, 0, 250, 250); // 清除畫布
                        ctx.save();                    // 保存畫布狀態
                        ctx.translate(250, 250);       // 將畫布中心移至(250,250)
                        ctx.rotate(angle * Math.PI / 180); // 將畫布旋轉特定角度
                        ctx.translate(-250, -250);     // 將畫布中心移回原位
                        drawWheel();                   // 繪製轉盤
                        ctx.restore();                 // 恢復畫布狀態
                        
                        if (progress < duration) {
                            window.requestAnimationFrame(step); //未達到的話繼續轉
                        } 
                        else {
                            selectedOptionIndex = Math.floor(((360 - (spinTo % 360)) / 360) * options.length); //計算被選中得選項
                            result.textContent = `結果：${options[selectedOptionIndex].option}`; //顯示結果
                            check = false; //重置轉盤
                            
                        }
                    };
                    window.requestAnimationFrame(step); //啟動動畫
                }
            }
        }
    }
    
    //-------------------------旋轉時間------------------------//
    function easeOutCubic(time, begin, change, duration) { //進行的時間、開始的初始值、變化量、持續時間
        time /= duration;   //動畫進行的比例
        time--;             //變化範圍-1-0
        return change*(time*time*time + 1) + begin; 
    }
    
    drawWheel();//初始化
</script>